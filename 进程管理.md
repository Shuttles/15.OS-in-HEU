OS的四个特征

并发性，异步性(走走停停)，共享性，虚拟性



这些特征都是由进程引起的



# 章重点

1. 理解进程的含义
2. 理解和掌握同步的概念及经典***<u>进程同步</u>***的问题



# 难点

会写***<u>进程同步</u>***问题的算法



# 知识点

进程、线程、进程的特征、PCB、进程控制、进程状态转换、进程同步、进程通信





# 进程的基本概念

## 程序的顺序执行及其特征

1. 两种方式

   + 顺序执行

     是单道批处理系统的执行方式，也用于简单的单片机系统

   + 并发执行

     现在的操作系统，具有许多新的特征、引入并发执行的目的是为了提高资源利用率

2. 顺序执行的特征

   + 顺序性

   + 封闭性

     独占全部资源

   + 可再现性

     初始条件相同则结果相同





## 前驱图

是一个有向无环图，用于描述进程之间执行的前后关系。

图中每个结点可用于描述一个进程

## 程序的并发执行及其特征

### 特征

1. 异步性(间断性)

   即走走停停，一个程序可能走到中途停下来，失去原有的时序关系

2. 失去封闭性

   ***<u>共享资源</u>***，受其他程序的控制逻辑的影响

   比如： 一个程序写到存储器中的数据可能被另一个程序修改，失去原有的不变特征。

3. 失去可再现性

   因为失去了封闭性，所以导致失去可再现性

我们设计os，是从用户的角度看的，所以要尽量避免失去封闭性及可再现性



### 改进

并发执行失去封闭性的原因是共享资源的影响，去掉这种影响就行了。

1966年，由Bernstein给出并发执行的条件(这里没有考虑执行速度的影响)

***<u>即只需并发执行的程序之间只能同时读共享资源</u>***！！！

![img](https://wx2.sinaimg.cn/mw690/005LasY6gy1gcyfwafcbgj30op0asq49.jpg)





## 进程的概念

1. 老师给的ppt中的定义

   计算机中的所有程序(软件)，按照某种顺序执行，这种***<u>运行的过程</u>***称之为进程。

![img](https://wx3.sinaimg.cn/mw690/005LasY6gy1gcyfz8jr8fj30o90fljso.jpg)



### 核心思想

1. 进程是某种类型的一个活动，它有程序、输入、输出和状态。
2. 在分时操作系统中，单个CPU被若干进程共享，它使用某种调度算法决定何时停止一个进程的运行，转而为其他进程提供服务。



### 其他定义

经典定义：

1. 进程是程序的一次执行过程
2. 进程是一个程序及其数据在cpu上顺序执行时所发生的的活动
3. 进程是程序在一个数据集合上运行的过程，它是系统进行资源分配和调度的一个独立单位



在引入了进程实体的概念后，我们可以把传统OS中的进程定义为

***<u>进程是进程实体的运行过程，是系统进行资源分配和调度的一个独立单位。</u>***





## 进程的特征与状态

1. 动态性

   进程具有动态的地址空间(数量和内容)

   地址空间上包括

   + 代码(指令执行和cpu状态的改变)
   + 数据(变量的生成和赋值)
   + 系统控制信息(进程控制块的建立和系统收回)

   印老师说，这就相当于***<u>“人不能两次踏入同一条河流”</u>***

2. 独立性

   各进程的地址空间相互独立，除非采用进程通信手段。

3. 并发性

   多个进程实体同存于内存中，且能在一段时间内同时运行。

   ***<u>引入进程实体的目的就是并发执行</u>***。

4. 异步性

   各进程按各自独立的、不可预知的速度向前推进

   PS ： ***<u>并发性必然引起异步性！</u>***

5. 结构性

   ***<u>程序段、数据段和PCB(进程控制块)</u>***

   程序文件中通常也划分了代码段和数据段，进程的创建与撤销就是PCB的创建与撤销



### 进程与程序的区别

1. 进程是动态的，程序是静态的

2. 进程是暂时的，程序是永久的

3. 进程与程序的组成不同

   进程的组成包括程序、数据和PCB(即进程控制块，进程状态信息)

4. 进程与程序的对应关系

   通过多次执行，一个程序可对应多个进程。

   通过调用关系，一个进程可包括多个程序。



### 进程的三种基本状态

1. 就绪(Ready)状态

   + 可运行，已获得除CPU外的所需资源，等待分配CPU(万事俱备，只欠东风)
   + 一个系统中多个出于就绪状态的进程排成***<u>就绪队列</u>***

2. 执行(Running)状态

   + 占用CPU运行

     处于此状态的进程的数目 `<=` CPU的数目

   + 没有其他进程可以执行时(如所有进程都在阻塞状态)，通常会自动执行系统的idle进程(相当于空操作)

3. 阻塞(Blocked)状态

   + 等待某种条件(如I/O操作或进程同步)，在条件满足之前***<u>无法继续执行</u>***。该事件发生前即使把CPU分配给该进程，也无法运行。
   + 通常阻塞进程也排成一个***<u>阻塞队列</u>***



![img](https://wx2.sinaimg.cn/mw690/005LasY6gy1gcy7c7bu87j30pm0hutbr.jpg)

#### 执行状态

分为两种

1. 用户态执行

   表示进程正处于用户状态之中。

   进程所能访问的内存空间和对象收到限制。

   ***<u>可被剥夺</u>***(比如*<u>有优先级高的进程到来、时间片用完</u>*)

2. 核心态执行

   一个应用进程执行系统调用后(或I/O中断后，或时钟中断后)，进程则能访问所有的内存空间和对象

   ***<u>不可被剥夺</u>***



![img](https://wx2.sinaimg.cn/mw690/005LasY6gy1gcy7calcd0j30r10fe40i.jpg)



### 1个问题

1. 为什么不能从阻塞态变为就绪态？

   因为I/O操作相对于CPU速度来说很慢，如果变为就绪态之后CPU空闲了但是I/O操作还没好，那就尴尬了

2. 结论

   + 三种状态的变化体现了OS的资源管理作用
   + 进程的核心思想在于运行--CPU资源的分配



### 挂起(Suspend)状态

1. 这个状态的出现是由于进程优先级的引入。

2. 定义：一些优先级低的进程可能等待较长时间，从而被对换至外存。

3. 目的是

   + 提高cpu效率

   + 为进程的运行提供足够的内存

   + 用于调试

     ***<u>在调试时，挂起被调试进程，从而对其地址空间进行读写</u>***

4. 引起挂起的原因

   + 终端用户的请求

     当用户在自己的程序运行期间发现有可以问题时，希望暂时将自己的程序静止下来

   + 父进程请求

     父进程需要考察和修改子进程

   + 负荷调节的需要

     在实时系统中为了调整工作负荷可将不重要的进程挂起

   + 操作系统的需要

     如检查运行中的资源使用情况



### 状态转换

挂起(suspend)，就是进程从内存转到外存

1. 就绪挂起

   活动就绪到静止就绪，当有高优先级阻塞(系统认为会很快就绪的)进程和低优先级阻塞进程时，系统会选择挂起低优先级就绪进程

2. 阻塞挂起

   活动阻塞到静止阻塞，无进程处于就绪状态或就绪进程要求更多内存时，会进行这种转换，以提交新进程或运行就绪进程。

3. 运行到就绪挂起

   对抢先式分时系统，当有高优先级阻塞挂起进程因事件出现而进入就绪挂起时，系统可能会把运行进程转到就绪挂起状态。

   (***<u>表示没看懂</u>***！！！！)



### 激活(Active)

即进程从外存转到内存

1. 就绪激活

   静止就绪到活动就绪，没有就绪进程或挂起就绪进程优先级高于就绪进程时，会进行这种转换

2. 阻塞激活

   静止阻塞到活动阻塞，当一个进程释放足够内存时，系统会把一个高优先级阻塞挂起进程激活



### 事件出现

即Event Occurs

进程等待的事件出现，如：操作完成、申请成功等，可能的情况有

1. 阻塞到就绪：针对内存进程的事件出现
2. 阻塞挂起到就绪挂起：针对外存进程的事件出现



### 收容(Admit)

收容一个新进程，进入就绪状态或就绪挂起状态。

进入就绪挂起的原因是系统希望保持一个大的就绪进程表



![img](https://wx4.sinaimg.cn/mw690/005LasY6gy1gcygmcrd2nj30oc0fp0u8.jpg)



## 进程控制块(PCB)

### 作用

是使一个在多道程序环境下不能独立运行的程序(含数据)，成为一个能独立运行的基本单位，一个能与其他进程并发执行的进程。

或者说，OS是根据PCB来对并发执行的进程进行控制和管理的。

***<u>就相当于一卡通</u>***！

### PCB中的信息

1. 进程标识符

   进程标识符用于惟一地标识一个进程。一个进程通常有两种标识符

   + 内部标识符(***<u>PID</u>***)

     在所有操作系统中，都为每一个进程赋予一个惟一地数字标识符，它通常是一个进程的序号。设置内部标识符主要是为了方便系统使用。

   + 外部标识符

     它由创建者提供，通常是由字母、数字组成，往往是由用户(进程)在访问该进程时使用。为了描述进程的家族关系，还应设置父进程标识及子进程标识。此外，还可设置用户标识，以指示拥有该进程的用户

2. CPU状态(现场保护区)

   主要是由CPU的各种寄存器中的内容组成的

   + 通用寄存器
   + 指令计数器(PC)
   + 程序状态字PSW
   + 用户栈指针

3. 进程调度信息

   存放与进程调度和进程对换有关的信息，包括

   + 进程状态
   + 进程优先级
   + 进程调度所需的其他信息
   + 事件

4. 进程控制信息

   + 程序和数据的地址

     是指进程的程序和数据所在的内存或外存地址，以便再调度到该进程执行时，能从PCB中找到其程序和数据

   + 进程同步和通信机制

   + 占用资源清单

   + 连接指针

   + 家族联系





### PCB的组织方式

1. 链接方式

   把具有同一状态的PCB用其中的链接自链接成一个队列，可形成就绪队列、若干个阻塞队列和空白队列。

2. 索引方式

   系统根据所有进程的状态建立几张索引表，如就绪索引表、阻塞索引表等，并把各索引表在内存的首地址记录在专用单元中。索引表中记录的是PCB在PCB表中的地址。







# 进程控制

职责是对系统中全部进程实施有效管理，包括

+ 创建新进程
+ 终止已结束进程
+ 终止由于某事件而无法运行下去的进程
+ 负责进程的状态转换

这些功能一般由OS的内核实现，操作系统的内核是基于硬件的第一次扩充。把与硬件紧密相关的模块、运行频率较高的模块及一些公用的基本操作安排在靠近硬件的软件层次中，并常住内存，以提高系统运行效率



这些进程控制功能是用过执行各种原语实现的！



## 原语

1. 由若干条指令构成的

2. 系统调用并不都是原语。

   进程A调用



## CPU的执行状态--保护系统程序

1. 核心态
2. 用户态





## 进程的创建

### 进程图

1. 是用于描述一个进程的家族关系的树，树中的结点表示进程

2. 几个概念

   父进程、子进程、祖先进程

3. 子进程可以继承父进程的资源

4. 撤销父进程同时必须同时撤销子进程



### 引起创建进程的事件

在多道程序环境中，要运行程序，必须为其创建进程

1. 用户登录

   分时系统的用户在terminal登录后，如是合法用户，系统将为其创建一个进程，并插入就绪队列。

2. 作业调度

   在批处理系统中，当作业调度程序调到某作业时，将该作业装入内存，为他分配资源并创建进程

3. 提供服务

   当运行中的用户进程提出某种请求后，系统将专门创建一个进程来提供服务，如打印

4. 应用请求

   由应用程序为自己创建进程，以便能并发执行，如输入、计算、输出程序

### 创建过程

1. ***<u>申请空白PCB</u>***

   为新进程申请唯一的数字标识符，并从PCB集合中索取一个空白PCB

2. ***<u>为新进程分配资源</u>***

   为

3. ***<u>初始化PCB</u>***

   + 初始化信息标识
   + 初始化CPU状态信息
   + 初始化CPU控制信息

4. ***<u>将新进程插入就绪队列</u>***





## 进程终止

### 引起进程终止的事件

1. 正常结束

2. 异常结束

   在进程运行期间，由于出现某些错误和故障而迫使进程终止。

   + 越界错误

   + 保护错误

   + 非法指令

   + 特权指令错误

   + 运行超时

   + 等待超时

   + 算术运算错

     如0被除

   + I/O故障

   + 外界干预

     + 操作员干预
     + 父进程请求
     + 父进程终止





### 终止过程

1. 根据标识符，从PCB集合中检索出该进程的PCB
2. 若
3. 若该进程还有子孙进程，还应将其所有子孙进程予以终止，以防它们称为不可控的进程
4. 将被终止进程所拥有的的全部资源，或者归还给其父进程，或者归还给系统
5. 撤销PCB





## 进程的阻塞与唤醒

### 引起进程阻塞和唤醒的事件

1. 请求系统服务

   如请求打印机时

2. 启动某种操作

   当进程

3. 新数据尚未到达

   对于相互合作的进程，如果一个进程需要另一合作进程提供的数据，则在数据到达之前只能阻塞

4. 无新工作可做

   系统中的一些特殊功能进程，在完成了任务之后，等待新任务到来。如系统中的发送进程



### 阻塞过程

1. 正在执行的进程，当发现上述某事件时，因无法继续执行，进程便通过调用阻塞原语block()把自己阻塞***<u>可见，进程的阻塞是进程自身的一种主动行为。</u>***
2. 进入block过程后，由于此时该进程还处于执行状态，所以应该先立即停止执行，把PCB中的现行状态
3. 若系统中设置了因不同事件而阻塞的多个阻塞队列，则将本进程插入到具有相同事件的阻塞队列
4. 调度程序进程重新调度，将CPU分配给另一就绪进程



### 唤醒过程

1. 当被阻塞进程所期待的事件出现时，如I/O完成或其所期待的数据已经到达，
2. 唤醒原语执行的过程是
   + 把被阻塞的进程从等待该事件的阻塞队列中移出
   + 将其PCB中的现行状态由阻塞改为就绪
   + 将该PCB插入到就绪队列中



## 进程的挂起与激活

### 挂起过程



### 激活过程







# 进程同步

<u>**在进入学校的笔记前，先给出百度百科的解释，因为学校的这部分知识我没学明白。。**</u>

<u>***或者说，学校ppt没把我讲懂***</u>

> **同步的概念**
>
> 我们把异步环境下的一组并发进程因***<u>直接制约而互相发送消息</u>***、进行互相合作、互相等待，使得各进程按一定的速度执行的过程称为进程间的同步。
>
> 具有同步关系的一组并发进程称为[合作进程](https://baike.baidu.com/item/合作进程)，合作进程间互相发送的信号称为***<u>消息或事件。</u>*** 如果我们对一个消息或事件赋以唯一的消息名，则我们可用过程　wait (消息名)　 表示进程等待[合作进程](https://baike.baidu.com/item/合作进程)发来的消息，而用过程　signal (消息名) 表示向合作进程发送消息
>
> 



==后来发现，百度百科的这段内容只是”进程间的同步“，这只描述了间接制约关系！！==

## 进程同步的基本概念

### 两种形式的制约关系

在多道程序环境下，当程序并发执行时，由于*<u>**资源共享和进程合作**</u>*，使同处于系统中的各进程之间存在两种形式的制约关系

1. 间接相互制约关系

   源于资源共享，比如打印机、cpu等设备，只能分配给一个进程用，所以也称为”==互斥==“

2. 直接相互制约关系

   源于进程间的合作。

   如进程A向B提供数据，当输入缓冲为空时，B不能得到数据而阻塞；反之当缓冲满时，A无法写入而阻塞，又称为”==同步==“



==为了协调这种互相制约的关系，实现资源共享和进程协作，从而避免进程之间的冲突，引入了进程同步。==(最终才搞懂，原来这是所谓的”进程同步“)



下面是2020.4.1上课笔记



### 示例

![img](https://wx4.sinaimg.cn/mw690/005LasY6gy1gdeb2t7qv0j30r60j075h.jpg)

![img](https://wx1.sinaimg.cn/mw690/005LasY6gy1gdeb2xdxnfj30oj0ikgmu.jpg)

![img](https://wx1.sinaimg.cn/mw690/005LasY6gy1gdeb67l842j30p30iognf.jpg)

但是我们不能人为规定谁先做谁后做！！



### 为什么要进程同步呢？

![img](https://wx4.sinaimg.cn/mw690/005LasY6gy1gdebkown7lj30r80ibgpt.jpg)



### 一些概念

1. 临界资源(Critical Resouce)

   + ==一次仅允许一个进程使用的资源==
   + 系统中许多硬件如打印机等，各个进程之间只能用互斥的方式进行访问

2. 临界区(Critial section)

   + ==在每个进程中访问临界资源的那段代码称为临界区==

   + 每个进程进入临界区之前应先对欲访问的临界资源进行检查，看是否正在被访问。如果未被访问，该进程可进入临界区，并设置它正在被访问的标志。

     在临界区之前执行的这段代码称为==进入区(entry section)==

   + 在临界区之后也要加上一段代码，用于将临界区被访问的标志恢复为未被访问的标志，称为退出区(exit section)



### 同步机制应遵循的规则

![img](https://wx1.sinaimg.cn/mw690/005LasY6gy1gdmcqpqhmqj30mk0e8q4h.jpg)





## 信号量机制

![img](https://wx2.sinaimg.cn/mw690/005LasY6gy1gdmdmnq960j30oi0estaq.jpg)

==信号量代表可用资源实体的数量！！！！==



### 整形信号量

![img](https://wx1.sinaimg.cn/mw690/005LasY6gy1gdmdomucyvj30q50ikmzw.jpg)





### 记录型信号量

![img](https://wx1.sinaimg.cn/mw690/005LasY6gy1gdmdpqa71cj30po0ik0vd.jpg)

==与整型信号量不同的只是多出了一个等待的进程链表！！==

![img](https://wx3.sinaimg.cn/mw690/005LasY6gy1gdmdriastej30pd0jz40i.jpg)

![img](https://wx2.sinaimg.cn/mw690/005LasY6gy1gdmdwl76llj30rw0joadn.jpg)





### And型信号量

![img](https://wx3.sinaimg.cn/mw690/005LasY6gy1gdmdzou6k6j30qq0k8ad5.jpg)

![img](https://wx1.sinaimg.cn/mw690/005LasY6gy1gdmemayhlbj30qq0i4n0a.jpg)

![img](https://wx3.sinaimg.cn/mw690/005LasY6gy1gdmemf0pgjj30qo0ipdhw.jpg)



### 信号量集

![img](https://wx3.sinaimg.cn/mw690/005LasY6gy1gdmemp4ednj30ql0k6acz.jpg)

![img](https://wx4.sinaimg.cn/mw690/005LasY6gy1gdmemu7qxej30rf0jnmyw.jpg)

![img](https://wx2.sinaimg.cn/mw690/005LasY6gy1gdmen470l9j30pk0h0q5d.jpg)





下面是4.8的笔记

 





# 测试题

判断

1. PCB的组织方式主要有顺序方式和索引方式两种

   F (是链接方式和索引方式)

2. 当一个新进程刚刚建立，还未将其放入就绪队列时的状态，称为新(创建)状态

   T



填空

1. 通常情况下，引起进程阻塞和唤醒的事件有

+ 







